---
title: "Preprocessing"
author: Arend Lis
bibliography: references.bib
biblio-style: apalike
link-citation: yes
colorlinks: yes
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Preprocessing}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", message = TRUE, warning = FALSE
)
```

```{r setup}
library(PRONE)
```

# Load Data (TMT)

Here, we are directly working with the [SummarizedExperiment](https://bioconductor.org/packages/release/bioc/html/SummarizedExperiment.html) data. For more information on how to create the SummarizedExperiment from a proteomics data set, please refer to the ["Get Started"](PRONE.html) vignette.

The example TMT data set originates from [@biadglegne_mycobacterium_2022].

```{r load_real_tmt}
data("tuberculosis_TMT_se")
se <- tuberculosis_TMT_se
```

```{r, eval = TRUE, include = FALSE}
se <- subset_SE_by_norm(se, ain = c("raw", "log2"))
```

# Overview of the Data

To get an overview on the number of NAs, you can simply use the function `get_NA_overview()`:

```{r overview_NA_table}
get_NA_overview(se, ain = "log2")
```

To get an overview on the number of samples per sample group or batch, you can simply use the function `plot_condition_overview()` by specifying the column of the meta-data that should be used for coloring. By default (condition = NULL), the column specified in `load_data()`will be used.

```{r overview_plots}
plot_condition_overview(se, condition = NULL)

plot_condition_overview(se, condition = "Pool")
```

A general overview of the protein intensities across the different samples is provided by the function `plot_heatmap()`. The parameter "ain" specifies the data to plot, currently only "raw" and "log2" is available (names(assays(se)). Later if multiple normalization methods are executed, these will be saved as assays, and the normalized data can be visualized.

```{r overview_heatmap}
available_ains <- names(SummarizedExperiment::assays(se))

plot_heatmap(se, ain = "log2", color_by = c("Pool", "Group"), label_by = NULL, only_refs = FALSE)
```

Similarly, an upset plot can be generated to visualize the overlaps between sets defined by a specific column in the metadata. The sets are generated by using non-NA values. 

```{r overview_upset, fig.width = 8, fig.height = 8}
plot_upset(se, color_by = NULL, label_by = NULL, mb.ratio = c(0.7,0.3), only_refs = FALSE)
```

If you are interested in the intensities of specific biomarkers, you can use the `plot_markers_boxplots()` function to compare the distribution of intensities per group. The plot can be generated per marker and facet by normalization method (facet_norm = TRUE) or by normalization method and facet by marker (facet_marker = TRUE).

```{r}
p <- plot_markers_boxplots(se, markers = c("Q92954;J3KP74;E9PLR3", "Q9Y6Z7", "Q68CQ4"), ain = "log2", id_column = "Protein.IDs", facet_norm = FALSE, facet_marker = TRUE)
p[[1]] + ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, vjust = 0.5))
```


# Filter Proteins 

## Remove Proteins With Missing Values in ALL Samples

```{r}
se <- filter_out_complete_NA_proteins(se)
```

## Remove Proteins With a Specific Value in a Specific Column

Typically proteins with "+" in the columns "Reverse", "Only.identified.by.site", and "Potential.contaminant" are removed in case of a MaxQuant proteinGroups.txt output file.

```{r}
se <- filter_out_proteins_by_value(se, "Reverse", "+")
se <- filter_out_proteins_by_value(se, "Only.identified.by.site", "+")
#se <- filter_out_proteins_by_value(se, "Potential.contaminant", "+")
```

## Remove Proteins by ID

If you don't want to remove for instance all proteins with "Potential.contaminant == +", you can also first get the protein ID with the specific value, check them in Uniprot, and then remove only some by using the function `filter_out_proteins_by_ID()`.

```{r} 
pot_contaminants <- get_proteins_by_value(se, "Potential.contaminant", "+")
se <- filter_out_proteins_by_ID(se, pot_contaminants)
```

## Explore Missing Value Pattern

Due to the high amount of missing values in MS-based proteomics data, it is important to explore the missing value pattern in the data. The function `plot_NA_heatmap()` provides a heatmap of the proteins with at least one missing value across all samples. 

```{r}
plot_NA_heatmap(se, color_by = NULL, label_by = NULL, cluster_samples = TRUE, cluster_proteins = TRUE)
```

Another way to explore the missing value pattern is to use the functions `plot_NA_density()` and `plot_NA_frequency()`. 

```{r}
plot_NA_density(se)
```

```{r}
plot_NA_frequency(se)
```

## Filter Proteins By Applying a Missing Value Threshold

To reduce the amount of missing values, it is possible to filter proteins by applying a missing value threshold. The function `filter_out_NA_proteins_by_threshold()` removes proteins with more missing values than the specified threshold. The threshold is a value between 0 and 1, where 0.7, for instance, means that proteins with less than 70% of real values will be removed, i.e., proteins with more than 30% missing values will be removed.

```{r}
se <- filter_out_NA_proteins_by_threshold(se, thr = 0.7) 

plot_NA_heatmap(se)
```

# Filter Samples

Following filtering proteins by different criteria, samples can be analyzed more in detail. PRONE provides some functions, such as `plot_nr_prot_samples()` and `plot_tot_int_samples()`, to get an overview of the number of proteins and the total intensity per sample, but also offers the automatic outlier detection method of POMA.

## Quality Control

```{r}
plot_nr_prot_samples(se, color_by = NULL, label_by = NULL)

plot_tot_int_samples(se, color_by = NULL, label_by = NULL)
```

## Remove Samples Manually

Based on these plots, samples "1.HC_Pool1" and 1_HC_Pool2 seem to be outliers. You can easily remove samples manually by using the `remove_samples_manually()` function.

```{r}
se <- remove_samples_manually(se, "Label", c("1.HC_Pool1", "1.HC_Pool2"))
```

## Remove Reference Samples

And you can remove the reference samples directly using the function `remove_reference_samples()`. But attention: possibly you need them for normalization! That is exactly why we currently keep them!

```{r}
se_no_refs <- remove_reference_samples(se)
```


## Outlier Detection via POMA R Package

The POMA R package provides a method to detect outliers in proteomics data. The function `detect_outliers_POMA()` detects outliers in the data based on the POMA algorithm. The function returns a list with the following elements: polygon plot, distance boxplot, and the outliers. For further information on the POMA algorithm, please refer to the original publication [@castellano-escuder_pomashiny:_2021]: 

```{r}
poma_res <- detect_outliers_POMA(se, ain = "log2")

poma_res$polygon_plot

poma_res$distance_boxplot

DT::datatable(poma_res$outliers, options = list(scrollX = TRUE))
```

To remove the outliers detected via the POMA algorithm, just put the data.table of the `detect_outliers_POMA()` function into the `remove_POMA_outliers()` function.

```{r}
se <- remove_POMA_outliers(se, poma_res$outliers)
```

# Session Info

```{r}
utils::sessionInfo()
```

# References

